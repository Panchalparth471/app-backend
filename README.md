# KindPilot — Backend (Express + MongoDB)

**Repository:** Backend for KindPilot — an AI-powered app to improve parent–child relationships.  
This README documents what this backend does, its features, system architecture, models, API endpoints, environment variables, and how to set it up and run. (All information below is taken from the project files and from your description.)

---

# Table of contents

- [Project overview](#project-overview)
- [Features (backend-facing)](#features-backend-facing)
- [System architecture](#system-architecture)
- [Directory / important files](#directory--important-files)
- [Models (summary of Mongoose schemas)](#models-summary-of-mongoose-schemas)
- [API endpoints (routes)](#api-endpoints-routes)
- [Environment variables (`.env`) — keys & meaning](#environment-variables-env---keys--meaning)
- [Local setup / run instructions](#local-setup--run-instructions)
- [Database seeding](#database-seeding)
- [Static files / uploads](#static-files--uploads)
- [Other notes found in repo](#other-notes-found-in-repo)

---

# Project overview

This Express.js backend implements the API for KindPilot:

- Stores data in **MongoDB** (Mongoose models included).
- Provides authentication for parent accounts (JWT).
- Serves parent dashboard data, child-mode endpoints, story and activity resources.
- Integrates with AI services:
  - Uses **OpenAI** for text generation and Whisper transcription.
  - Uses **ElevenLabs** for text-to-speech (TTS) / voice cloning features (optional, controlled by env flags).
- Persists chat history and planner data (weekly planners generated by AI; parents can edit them).
- Hosts AI-generated audio files under `public/ai-audio` and exposes them.
- Has endpoints to transcribe audio and synthesize voice audio.
- Built to be deployed (this project was deployed to Railway Pro in your setup) and used by a React Native app (mobile client). An APK was also built for the mobile client (frontend), separate from this backend.

---

# Features (backend-facing)

- Parent authentication and onboarding.
- Parent dashboard and child management (create/list/delete children).
- Child-mode endpoints (deliver age-appropriate content, play/complete tracking, favorites).
- Stories:
  - CRUD-ish endpoints for stories.
  - Accepts AI-generated stories (many sample AI stories and a `public/ai-audio` folder are included).
  - Play / mark-complete / rate endpoints for stories.
- Activities: list, create, featured, categories, types, attempt/complete/rate endpoints.
- Planner:
  - Store weekly planners per parent.
  - AI-generated weekly planner integration (server-side endpoints).
- Chat:
  - Stores chat history per parent (messages with suggestions).
  - Voice-enabled chat: transcription endpoint(s) using Whisper and TTS using ElevenLabs.
- Voice endpoints:
  - Create/list/delete voice clones (ElevenLabs - optional).
  - Synthesize speech / recognize speech endpoints.
- AI-related utilities and endpoints (regenerate story, initialize categories, AI coach endpoint).

---

# System architecture (high-level)

- **Client:** React Native app (mobile) — interacts with this backend.
- **Backend:** Node.js / Express.js API server (this repository).
  - Routes are grouped under `/api/...` (see endpoints below).
  - Middleware: `auth` middleware (JWT token), rate-limiting, helmet, compression, CORS, body-parsing, file uploads (in `uploads/`).
- **Database:** MongoDB (MONGODB_URI).
- **AI Services (external):**
  - **OpenAI** — text generation (stories, coach), Whisper (audio transcription). Controlled via `OPENAI_API_KEY`.
  - **ElevenLabs** — text-to-speech and optional voice cloning. Controlled via `ELEVENLABS_API_KEY` and related flags.
- **Static hosting:** `public/ai-audio` contains pre-generated mp3s; `/ai-audio` static route serves audio.
- **Deployment:** This repo was deployed to Railway Pro (as per your note).

---

# Directory / important files

(Top-level files / folders in this backend repo)

- `server.js` — main Express server and route mounting.
- `package.json` — project dependencies & scripts.
- `routes/` — all route handlers:
  - `auth.js`, `parent.js`, `child.js`, `stories.js`, `activities.js`, `planner.js`, `chat.js`, `ai.js`, `voice.js`, `transcribe.js`, etc.
- `models/` — Mongoose models:
  - `Parent.js`, `Child.js`, `Story.js`, `Activity.js`, `Planner.js`, `Chat.js`
- `middleware/auth.js` — JWT authorization middleware.
- `seed.js` — script to seed sample stories & activities into MongoDB.
- `uploads/` — created at runtime, used for incoming uploads (voice uploads, etc).
- `public/ai-audio/` — included AI-generated mp3 audio files (sample story audios).
- `README.md` — (this file you are going to copy).
- `LICENSE` — repo license file.

---

# Models (summary of Mongoose schemas)

Below are the models included in the repo and the key fields each stores. (Field sets come from the model files in `models/`.)

## `Parent`
Key fields (non-exhaustive):
- `name` — String
- `email` — String (unique)
- `password` — String (bcrypt hashed)
- `children` — array of Child references (or child IDs)
- `createdAt`, `updatedAt` — timestamps
- `lastLogin` — Date
- helper instance methods: password hashing, last-login update, `getPublicProfile()` method to omit sensitive fields.

## `Child`
Key fields (non-exhaustive):
- `name` — String
- `age` — Number
- `avatar` / `gender` / `notes` — optional metadata fields (present in schema)
- `completedStories` — array of Story refs / IDs
- `completedActivities` — activity tracking
- `achievements` — array
- `mood` — current + history
- methods: `addAchievement()`, `updateMood()` utilities

## `Story`
Key fields:
- `title`, `description`, `content` — main story content
- `category`, `theme` — classification
- `ageRange` — `{ min, max }`
- `duration` — in minutes
- `thumbnail` — icon / emoji / url
- `learningObjectives` — array
- `skills` — array
- `audio` / `audioUrl` — path to TTS mp3 (if AI audio generated)
- `isAIGenerated` — Boolean
- `generatedForCollection` — optional collection key
- `createdBy` — parent reference or null
- `isActive`, `isPremium`, timestamps

## `Activity`
Key fields:
- `title`, `description`
- `type`, `difficulty`
- `ageRange`
- `duration`
- `materials`, `learningObjectives`, `skills`
- `variations`, `safetyNotes`
- `isAIGenerated`, `createdBy`, `isPremium`, `isActive`

## `Planner`
Key fields:
- `parentId` — ref to Parent
- `name` — e.g., "Weekly Plan"
- `plan` — mixed object (store of days/activities; structure is flexible)
- `createdAt`, `updatedAt`, `isActive`

## `Chat`
Key fields:
- `parent` — ref to Parent
- `messages` — array of messages; each message has:
  - `text`, `isUser` (boolean), `timestamp`, `suggestions` (array)
- `lastUpdated` — timestamp
- `timestamps` option enabled (createdAt/updatedAt)

---

# API endpoints (routes)

All API routes are mounted under `/api`. Below is a route-by-route listing discovered in the route files. For each route group the base path is shown, then the endpoints found in the code (HTTP method + path).

> Authorization: Endpoints that use the `auth` middleware require an `Authorization: Bearer <JWT>` header. The route files indicate which endpoints are protected; those are marked with **(auth required)** in the list below when detected.

---

## `/api/auth`  (auth.js)
- `POST /api/auth/onboard` — parent onboarding (register / signup).
- `POST /api/auth/login` — login (returns JWT).
- `POST /api/auth/forgot-password` — password reset initiation.
- `POST /api/auth/reset-password` — password reset action.

(Exact request/response shapes are implemented in `routes/auth.js`.)

---

## `/api/parent` (parent.js)
- `GET  /api/parent/dashboard` **(auth required)** — parent dashboard data (aggregated info).
- `GET  /api/parent/children` **(auth required)** — list children for the parent.
- `POST /api/parent/children` — add a child (route file implements create).
- `DELETE /api/parent/children/:childId` **(auth required)** — remove a child.
- `GET  /api/parent/progress/:childId` **(auth required)** — child progress data.
- `GET  /api/parent/suggestions/:childId` **(auth required)** — suggestions for a child.

---

## `/api/child` (child.js)
- `GET    /api/child/:childId/home` **(auth required)** — child home payload (content for child mode).
- `GET    /api/child/:childId/content/:contentId` **(auth required)** — get a specific content item.
- `POST   /api/child/:childId/play/:contentId` **(auth required)** — record play action.
- `POST   /api/child/:childId/complete/:contentId` **(auth required)** — mark content complete.
- `GET    /api/child/:childId/suggestions` **(auth required)** — get suggestions for child.
- `POST   /api/child/:childId/favorite/:contentId` **(auth required)** — favorite item.
- `DELETE /api/child/:childId/favorite/:contentId` **(auth required)** — remove favorite.
- `GET    /api/child/:childId/favorites` **(auth required)** — list favorites.

---

## `/api/stories` (stories.js)
- `GET  /api/stories/themes/list` — list story themes.
- `GET  /api/stories/categories/list` — list story categories.
- `GET  /api/stories/:id` — get story by id.
- `POST /api/stories/:id/play` — mark story play (play event).
- `POST /api/stories/:id/complete` — mark story complete.
- `POST /api/stories/:id/rate` — rate a story.
- `POST /api/stories/from-ai` — create story from AI payload.
- `POST /api/stories/` — create story.

---

## `/api/activities` (activities.js)
- `GET  /api/activities/` — list activities (with filters).
- `GET  /api/activities/featured` — list featured activities.
- `GET  /api/activities/:id` — get activity by id.
- `POST /api/activities/:id/attempt` — record attempt on activity.
- `POST /api/activities/:id/complete` — mark activity complete.
- `POST /api/activities/:id/rate` — rate an activity.
- `GET  /api/activities/types/list` — list activity types.
- `GET  /api/activities/categories/list` — list activity categories.
- `POST /api/activities/` — create activity.

---

## `/api/ai` (ai.js)
- `GET  /api/ai/category-stories/:categoryKey` **(auth required)** — get AI-generated stories for a category.
- `POST /api/ai/regenerate-story` **(auth required)** — regenerate a story (AI-powered).
- `POST /api/ai/initialize-categories` **(auth required)** — initialize categories / collections.
- `POST /api/ai/coach` — AI coach endpoint (chat/coach features).
- `POST /api/ai/tts` — TTS helper endpoint (server-side TTS calls).

---

## `/api/planner` (planner.js)
- `GET    /api/planner/:id` **(auth required)** — get planner by id.
- `POST   /api/planner/` — create or update planner (API supports saving planner).
- `DELETE /api/planner/:id` **(auth required)** — delete planner by id.

---

## `/api/chat` (chat.js)
- `GET  /api/chat/` — list chats for parent (and summary).
- `POST /api/chat/` — append or create a chat message (stores messages and suggestions).
- Chat model persists `messages` array with `text`, `isUser`, `timestamp`, `suggestions`.

---

## `/api/transcribe` (transcribe.js)
- `POST /api/transcribe/` — accepts audio uploads and returns transcription (Whisper/OpenAI transcription if `OPENAI_API_KEY` present).

---

## `/api/voice` (voice.js)
- `POST   /api/voice/clone` — (attempt) create a voice clone via ElevenLabs (requires ElevenLabs flags/keys).
- `GET    /api/voice/clones` **(auth required)** — list created voice clones.
- `DELETE /api/voice/clones/:voiceId` **(auth required)** — delete a voice clone.
- `GET    /api/voice/status/:voiceId` **(auth required)** — check voice clone status.
- `POST   /api/voice/synthesize` — synthesize TTS audio (uses ElevenLabs if `ELEVENLABS_API_KEY` present or other TTS).
- `POST   /api/voice/recognize` — recognize speech (Whisper / transcription) — depends on `OPENAI_API_KEY`.

---

# Environment variables (`.env`) — keys & meaning

Create a file such as `config.env` or `.env` with the variables used by this backend. The server references these environment variables:

```env
# Required / important
PORT=3000
NODE_ENV=development
MONGODB_URI= # mongodb connection string (e.g. mongodb://localhost:27017/kindpilot or a cloud URI)
JWT_SECRET= # secret string for signing JWT tokens

# OpenAI (text generation, Whisper transcription)
OPENAI_API_KEY=
OPENAI_MODEL= # optional, e.g. "gpt-4o" or the model you select in code

# ElevenLabs (TTS / voice cloning) - optional
ELEVENLABS_API_KEY=
ELEVENLABS_VOICE= # default voice ID to use for synthesis
ELEVENLABS_VOICE_CLONE_ENABLED=true|false
ELEVENLABS_VOICE_CREATE_URL= # optional override

# Tuning params used by voice endpoints (optional)
ELEVEN_SIMILARITY_BOOST=
ELEVEN_VOICE_STABILITY=

# Hosting / other
HOSTNAME= # optional base URL used to build returned audio paths
TARGET_PER_CATEGORY= # numeric target per category (if code uses)
```

**Notes:**
- `MONGODB_URI` is used by the server to connect to MongoDB (defaults to `mongodb://localhost:27017/kindpilot` in code if not set).
- `JWT_SECRET` must be set to enable auth signing.
- `OPENAI_API_KEY` enables OpenAI calls (text generation and transcription).
- `ELEVENLABS_API_KEY` enables ElevenLabs TTS/voice features. Voice cloning endpoints will only attempt cloning if related flags/keys are set.

---

# Local setup / run instructions

1. **Clone / copy the backend repo** (or unzip the provided archive).

2. **Install dependencies**
   ```bash
   cd path/to/app-backend
   npm install
   ```

3. **Create config / environment file**

   Create a `config.env` or `.env` file at the project root and populate the environment variables listed above (at minimum set `MONGODB_URI` and `JWT_SECRET` for development).

4. **Ensure MongoDB is running**

   Set `MONGODB_URI` to your MongoDB connection string (or rely on the default `mongodb://localhost:27017/kindpilot` if running a local mongo).

5. **(Optional) Seed sample data**

   The repo includes `seed.js` which inserts sample stories and activities.

   To run seeding:
   ```bash
   node seed.js
   ```
   The seed script expects environment variables (it loads `config.env` via dotenv).

6. **Start server**

   Development (with nodemon, if installed globally or available):
   ```bash
   npm run dev
   ```

   Production / normal:
   ```bash
   npm start
   ```

   By default server will run on `PORT` (default 3000). Health check endpoint: `GET /api/health`.

7. **Uploads and audio**

   On startup the server ensures `uploads/` and `uploads/voice/` directories exist.

   `public/ai-audio` contains ai-generated mp3 files already included; these are served at `/ai-audio/<filename>.mp3`.

---

# Database seeding

`seed.js` exists to insert sample Story and Activity documents.

- The script uses `config.env` by default (via dotenv) — ensure that file is present with `MONGODB_URI`.
- Run `node seed.js` to insert sample content and then disconnect.

---

# Static files / uploads

**Static serving:**

- `/uploads` served from `uploads/` directory (used for file/voice uploads).
- `/ai-audio` served from `public/ai-audio/` (contains mp3 story audios).

The project creates these folders at startup if they are missing.

---

# Other notes found in repo

- Rate limiting is enabled for `/api/` routes (100 requests per 15 minutes by IP).
- Security middleware used: helmet, compression, cors.
- Logging: `morgan('dev')` when `NODE_ENV === 'development'`.
- The auth middleware expects the `Authorization` header `Authorization: Bearer <token>`.
- `server.js` prints the healthcheck URL and database connection state on startup.

**Quick troubleshooting hints (purely factual, not prescriptive)**
- If you see MongoDB connection error logs, confirm `MONGODB_URI`.
- If OpenAI or ElevenLabs calls do not work, confirm the corresponding API key env variables are present.
- The server defaults to `mongodb://localhost:27017/kindpilot` if `MONGODB_URI` is not provided.

---

# Example: Minimal .env (copy / paste)

```env
PORT=3000
NODE_ENV=development
MONGODB_URI=mongodb://localhost:27017/kindpilot
JWT_SECRET=replace-with-a-secure-string


OPENAI_API_KEY=sk-...
# Optional (for AI features)
OPENAI_MODEL=gpt-4o


ELEVENLABS_API_KEY=elevenlabs-key
# Optional 
ELEVENLABS_VOICE=your-default-voice-id
ELEVENLABS_VOICE_CLONE_ENABLED=false
```

---

# Contact / attribution

This README was generated from the repository files included in the backend archive and from the project description you provided: an AI-powered parent–child relationship app with parent dashboard, child mode, AI-generated audio stories (OpenAI + ElevenLabs), AI weekly planner, voice-enabled chat (Whisper), saved chat history, deployed to Railway Pro, and an APK built for the client.
